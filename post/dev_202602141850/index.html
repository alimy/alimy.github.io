<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <title> Thrift THeader协议 &middot; 那年江湖，遇见你 </title>
  
  <link rel="stylesheet" type="text/css" href="https://alimy.github.io//css/uno.css" />
  <link rel="stylesheet" type="text/css" href="https://alimy.github.io//css/lightGallery.css" />
  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://alimy.github.io/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://alimy.github.io/favicon.png">
  
  <script src="https://alimy.github.io//js/jquery.min.js"></script>
  <script src="https://alimy.github.io//js/main.min.js"></script>

  <script data-host="https://riiffy.com" data-dnt="false" src="https://riiffy.com/js/script.js" id="ZwSg9rf6GA" async
    defer></script>

  <style type="text/css">
    body {
      background-color: #f9f9f9;
    }

    .panel-wrapper {
      box-shadow: 0px 0px 8px rgba(68, 68, 68, .6);
      -moz-box-shadow: 0px 0px 8px rgba(68, 68, 68, .6);
      border-radius: 4px;
      -moz-border-radius: 4px;
      padding: 16px 24px;
      margin-top: 32px;
      background-color: #fff
    }

    .panel-wrapper:hover {
      box-shadow: 0px 0px 12px rgba(68, 68, 68, .6);
      -moz-box-shadow: 0px 0px 12px rgba(68, 68, 68, .6);
    }

    #more {
      margin-top: 16px;
    }

    #copyright {
      padding: 2em 0 0;
      display: block;
      font-size: .9em;
      color: #b3b3b3;
      width: 100%;
      text-align: center
    }

    #list-indicator {
      min-width: 48px;
      text-align: center;
      float: right;
      margin-right: 64px;
      background: rgba(68, 68, 68, .2);
      border-radius: 4px;
      -moz-border-radius: 4px;
      padding: 8px;
    }

    #list-date {
      color: #999;
      font-size: .9em;
      font-style: italic;
    }

    .post-tags-item {
      padding-left: .75rem !important;
      padding-right: .75rem !important;
      padding-top: .25rem !important;
      padding-bottom: .25rem !important;
      margin-right: .5rem !important;
      margin-top: .25rem !important;
      margin-bottom: .25rem !important;
      font-size: .875rem !important;
      color: #666666;
      display: inline-block !important;
      border-radius: .25rem !important;
      background-color: rgb(242 242 247) !important;
    }

    .post-tags-item:hover {
      color: #38b2ac;
    }

    #post-navigator {
      padding: 24px 0px 16px 0px;
      vertical-align: middle;
    }

    #post-navigator>a {
      display: block;
      color: #2479cc;
      text-decoration: none;
    }

    #post-navigator-prev {
      float: left;
    }

    #post-navigator-next {
      float: right;
    }

    .pages {
      text-align: center;
      margin-right: -15px;
      margin-left: -15px;
    }

    .pages>ul {
      font-weight: lighter;
    }

    .pages>.pagination {
      display: inline-block;
      padding-left: 0;
      margin: 20px 0px;
      border-radius: 4px;
    }

    .pages .pagination>li {
      display: inline;
    }

    .pagination>.active>a,
    .pagination>.active>span,
    .pagination>.active>a:hover,
    .pagination>.active>span:hover,
    .pagination>.active>a:focus,
    .pagination>.active>span:focus {
      z-index: 2;
      color: #fff;
      cursor: default;
      background-color: #428bca;
      border-color: #428bca;
    }

    .pagination>li>a,
    .pagination>li>span {
      position: relative;
      float: left;
      padding: 6px 12px;
      margin-left: -1px;
      line-height: 1.428571429;
      text-decoration: none;
      background-color: #fff;
      border: 1px solid #ddd;
    }

    .pagination>li:first-child>a,
    .pagination>li:first-child>span {
      margin-left: 0;
      border-bottom-left-radius: 4px;
      border-top-left-radius: 4px;
    }

    .pagination>.disabled>span,
    .pagination>.disabled>span:hover,
    .pagination>.disabled>span:focus,
    .pagination>.disabled>a,
    .pagination>.disabled>a:hover,
    .pagination>.disabled>a:focus {
      color: #999;
      cursor: not-allowed;
      background-color: #fff;
      border-color: #ddd;
    }

    .pagination>li:last-child>a,
    .pagination>li:last-child>span {
      border-top-right-radius: 4px;
      border-bottom-right-radius: 4px;
    }

    *,
    *:before,
    *:after {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
  <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
        <i class="fa fa-bars btn-mobile-menu__icon"></i>
        <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
         panel-cover
        panel-cover--collapsed " 
        style="background-image: url(/images/cover.jpg)" >
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content">
                    <a href="https://alimy.github.io//"> <img src="https://alimy.github.io/images/logo.jpg"
                            width="256" alt="北野 logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="https://alimy.github.io//">北野</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  那年江湖，遇见你  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                                <li class="navigation__item"><a href="https://alimy.github.io/" title="博客首页"
                                        class="blog-button">首页</a> </li> </br></br>
                                <li class="navigation__item"><a href="https://alimy.github.io/post" title="文章列表"
                                        class="blog-button">文章列表</a> </li>
                                </br>  </br>
                                <li class="navigation__item"><a href="https://alimy.github.io/pages/cv" title="关于我 "
                                        class="blog-button">关于我</a> </li>
                                </br> 
                            </ul>
                            <nav class="cover-navigation navigation--social">
</br>
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="https://iibiubiu.com" title="@iiBiuBiu" target="_blank"> <i class='fa fa-anchor'></i> <span class="label">Twitter</span> </a>
        </li>
        <li class="navigation__item">
            <a href="https://www.paopao.info/#/u?s=alimy" title="@paopao" target="_blank"> <i class='fa fa-leaf'></i> <span class="label">Twitter</span> </a>
        </li><br>
        
        
        
          
        
        <li class="navigation__item">
            <a href="https://github.com/alimy" title="@GitHub" target="_blank"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>   </br>    </ul>
</nav>

                        </nav>
                    </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</div>
<noscript>
    <style>
        #scriptHeader {
            display: none;
        }

        .navigation-wrapper {
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/cover.jpg)">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="https://alimy.github.io//"> <img src="https://alimy.github.io/images/logo.jpg" width="80"
                            alt="北野 logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="https://alimy.github.io//">北野</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  那年江湖，遇见你  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                                <li class="navigation__item"><a href="https://alimy.github.io/" title="博客首页"
                                        class="blog-button">Blog</a> </li></br></br>
                                <li class="navigation__item"><a href="https://alimy.github.io//post/" title="文章列表"
                                        class="blog-button">Articles</a> </li>
                                </br>  </br>
                                <li class="navigation__item"><a href="https://alimy.github.io/pages/cv" title="关于我 "
                                        class="blog-button">About Me</a> </li>
                                </br> 
                            </ul>
                        </nav> <nav class="cover-navigation navigation--social">
</br>
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="https://iibiubiu.com" title="@iiBiuBiu" target="_blank"> <i class='fa fa-anchor'></i> <span class="label">Twitter</span> </a>
        </li>
        <li class="navigation__item">
            <a href="https://www.paopao.info/#/u?s=alimy" title="@paopao" target="_blank"> <i class='fa fa-leaf'></i> <span class="label">Twitter</span> </a>
        </li><br>
        
        
        
          
        
        <li class="navigation__item">
            <a href="https://github.com/alimy" title="@GitHub" target="_blank"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>   </br>    </ul>
</nav>

                    </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>
  <div class="content-wrapper">
    <div class="content-wrapper__inner">
      <div class="post panel-wrapper">
        <h2>Thrift THeader协议</h2>
        
        <p>Header format for the THeader.h</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>      <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">9</span> a b c d e f <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">9</span> a b c d e f
</span></span><span style="display:flex;"><span>    +----------------------------------------------------------------+
</span></span><span style="display:flex;"><span>    | 0|                          LENGTH                             |
</span></span><span style="display:flex;"><span>    +----------------------------------------------------------------+
</span></span><span style="display:flex;"><span>    | 0|       HEADER MAGIC          |            FLAGS              |
</span></span><span style="display:flex;"><span>    +----------------------------------------------------------------+
</span></span><span style="display:flex;"><span>    |                         SEQUENCE NUMBER                        |
</span></span><span style="display:flex;"><span>    +----------------------------------------------------------------+
</span></span><span style="display:flex;"><span>    | 0|     Header Size<span style="color:#f92672">(</span>/32<span style="color:#f92672">)</span>        | ...
</span></span><span style="display:flex;"><span>    +---------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                      Header is of variable size:
</span></span><span style="display:flex;"><span>                       <span style="color:#f92672">(</span>and starts at offset 14<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    +----------------------------------------------------------------+
</span></span><span style="display:flex;"><span>    |         PROTOCOL ID  <span style="color:#f92672">(</span>varint<span style="color:#f92672">)</span>  |   NUM TRANSFORMS <span style="color:#f92672">(</span>varint<span style="color:#f92672">)</span>     |
</span></span><span style="display:flex;"><span>    +----------------------------------------------------------------+
</span></span><span style="display:flex;"><span>    |      TRANSFORM <span style="color:#ae81ff">0</span> ID <span style="color:#f92672">(</span>varint<span style="color:#f92672">)</span>   |        TRANSFORM <span style="color:#ae81ff">0</span> DATA ...
</span></span><span style="display:flex;"><span>    +----------------------------------------------------------------+
</span></span><span style="display:flex;"><span>    |         ...                              ...                   |
</span></span><span style="display:flex;"><span>    +----------------------------------------------------------------+
</span></span><span style="display:flex;"><span>    |        INFO <span style="color:#ae81ff">0</span> ID <span style="color:#f92672">(</span>varint<span style="color:#f92672">)</span>      |       INFO <span style="color:#ae81ff">0</span>  DATA ...
</span></span><span style="display:flex;"><span>    +----------------------------------------------------------------+
</span></span><span style="display:flex;"><span>    |         ...                              ...                   |
</span></span><span style="display:flex;"><span>    +----------------------------------------------------------------+
</span></span><span style="display:flex;"><span>    |                                                                |
</span></span><span style="display:flex;"><span>    |                              PAYLOAD                           |
</span></span><span style="display:flex;"><span>    |                                                                |
</span></span><span style="display:flex;"><span>    +----------------------------------------------------------------+
</span></span></code></pre></div><p>The <code>LENGTH</code> field is 32 bits, and counts the remaining bytes in the
packet, NOT including the length field.  The header size field is 16
bits, and defines the size of the header remaining NOT including the
<code>HEADER MAGIC</code>, <code>FLAGS</code>, <code>SEQUENCE NUMBER</code> and header size fields.  The
Header size field is in bytes/4.</p>
<p>The transform ID&rsquo;s are varints.  The data for each transform is
defined by the transform ID in the code - no size is given in the
header.  If a transform ID is specified from a client and the server
doesn&rsquo;t know about the transform ID, an error MUST be returned as we
don&rsquo;t know how to transform the data.</p>
<p>Conversely, data in the info headers is ignorable.  This should only
be things like timestamps, debugging tracing, etc.  Using the header
size you should be able to skip this data and read the payload safely
if you don&rsquo;t know the info ID.</p>
<p>Info&rsquo;s should be oldest supported to newest supported order, so that
if we read an info ID we don&rsquo;t support, none of the remaining info
ID&rsquo;s will be supported either, and we can safely skip to the payload.</p>
<p>Info ID&rsquo;s and transform ID&rsquo;s should share the same ID space.</p>
<h3 id="padding">PADDING:</h3>
<p>Header will be padded out to next 4-byte boundary with <code>0x00</code>.</p>
<p>Max frame size is <code>0x3FFFFFFF</code>, which is slightly less than <code>HTTP_MAGIC</code>.
This allows us to distinguish between different (older) transports.</p>
<h3 id="transform-ids">Transform IDs:</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    ZLIB_TRANSFORM 0x01 - No data <span style="color:#66d9ef">for</span> this.  Use zlib to <span style="color:#f92672">(</span>de<span style="color:#f92672">)</span>compress the
</span></span><span style="display:flex;"><span>                          data.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    HMAC_TRANSFORM 0x02 - Variable amount of mac data.  One byte to specify
</span></span><span style="display:flex;"><span>                          size. Mac data is appended at the end of the packet.
</span></span><span style="display:flex;"><span>    SNAPPY_TRANSFORM  0x03  - No data <span style="color:#66d9ef">for</span> this.  Use snappy to <span style="color:#f92672">(</span>de<span style="color:#f92672">)</span>compress the
</span></span><span style="display:flex;"><span>                          data.
</span></span></code></pre></div><h3 id="info-ids">Info IDs:</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    INFO_KEYVALUE 0x01 - varint32 number of headers.
</span></span><span style="display:flex;"><span>                       - key/value pairs of varstrings <span style="color:#f92672">(</span>varint16 length plus
</span></span><span style="display:flex;"><span>                         no-trailing-null string<span style="color:#f92672">)</span>. Implementations MUST NOT
</span></span><span style="display:flex;"><span>                         alter either key or value in any way.
</span></span></code></pre></div>
        <div id="post-tags">
          
          
          <a href="https://alimy.github.io/tags/development/" class="post-tags-item"><i class="fa fa-tag" aria-hidden="true"></i>&nbsp;Development</a>
          
          <a href="https://alimy.github.io/tags/thrift/" class="post-tags-item"><i class="fa fa-tag" aria-hidden="true"></i>&nbsp;Thrift</a>
          
          <a href="https://alimy.github.io/tags/protocol/" class="post-tags-item"><i class="fa fa-tag" aria-hidden="true"></i>&nbsp;Protocol</a>
          
          <a href="https://alimy.github.io/tags/rpc/" class="post-tags-item"><i class="fa fa-tag" aria-hidden="true"></i>&nbsp;RPC</a>
          
          
        </div>
      </div>
      <div id="post-navigator">
        <a id="post-navigator-prev" href="https://alimy.github.io/post/dev_202602131240/" title="上一篇"><i class="fa fa-chevron-left"
            aria-hidden="true"></i>&nbsp;妙用Go类型定义避免循环引用</a>
        <a id="post-navigator-next" href="https://alimy.github.io/post/dev_202602141900/" title="下一篇">Kitex TTHeader协议&nbsp;<i
            class="fa fa-chevron-right" aria-hidden="true"></i></a>
      </div>
      
      <footer id="copyright">
  <p>&copy;2015-至今 <a href="mailto:alimy@niubiu.com" title="Email:alimy@niubiu.com">北野 - Michael Li</a> All rights
    reserved.&nbsp;&nbsp;<a href="https://riiffy.com/alimy.github.io" title="访问统计" target="_blank">Riiffy</p>
</footer>
    </div>
    <script>(function(){var WebP=new Image();WebP.onload=WebP.onerror=function(){
if(WebP.height!=2){var sc=document.createElement('script');sc.type='text/javascript';sc.async=true;
var s=document.getElementsByTagName('script')[0];sc.src='https://alimy.github.io/js/webpjs-0.0.2.min.js';s.parentNode.insertBefore(sc,s);}};
WebP.src='data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA';})();</script>

</body>

</html>