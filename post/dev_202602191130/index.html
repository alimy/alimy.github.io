<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <title> Memcached - A Story of Caching &middot; 那年江湖，遇见你 </title>
  
  <link rel="stylesheet" type="text/css" href="https://alimy.github.io//css/uno.css" />
  <link rel="stylesheet" type="text/css" href="https://alimy.github.io//css/lightGallery.css" />
  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://alimy.github.io/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://alimy.github.io/favicon.png">
  
  <script src="https://alimy.github.io//js/jquery.min.js"></script>
  <script src="https://alimy.github.io//js/main.min.js"></script>

  <script data-host="https://riiffy.com" data-dnt="false" src="https://riiffy.com/js/script.js" id="ZwSg9rf6GA" async
    defer></script>

  <style type="text/css">
    body {
      background-color: #f9f9f9;
    }

    .panel-wrapper {
      box-shadow: 0px 0px 8px rgba(68, 68, 68, .6);
      -moz-box-shadow: 0px 0px 8px rgba(68, 68, 68, .6);
      border-radius: 4px;
      -moz-border-radius: 4px;
      padding: 16px 24px;
      margin-top: 32px;
      background-color: #fff
    }

    .panel-wrapper:hover {
      box-shadow: 0px 0px 12px rgba(68, 68, 68, .6);
      -moz-box-shadow: 0px 0px 12px rgba(68, 68, 68, .6);
    }

    #more {
      margin-top: 16px;
    }

    #copyright {
      padding: 2em 0 0;
      display: block;
      font-size: .9em;
      color: #b3b3b3;
      width: 100%;
      text-align: center
    }

    #list-indicator {
      min-width: 48px;
      text-align: center;
      float: right;
      margin-right: 64px;
      background: rgba(68, 68, 68, .2);
      border-radius: 4px;
      -moz-border-radius: 4px;
      padding: 8px;
    }

    #list-date {
      color: #999;
      font-size: .9em;
      font-style: italic;
    }

    .post-tags-item {
      padding-left: .75rem !important;
      padding-right: .75rem !important;
      padding-top: .25rem !important;
      padding-bottom: .25rem !important;
      margin-right: .5rem !important;
      margin-top: .25rem !important;
      margin-bottom: .25rem !important;
      font-size: .875rem !important;
      color: #666666;
      display: inline-block !important;
      border-radius: .25rem !important;
      background-color: rgb(242 242 247) !important;
    }

    .post-tags-item:hover {
      color: #38b2ac;
    }

    #post-navigator {
      padding: 24px 0px 16px 0px;
      vertical-align: middle;
    }

    #post-navigator>a {
      display: block;
      color: #2479cc;
      text-decoration: none;
    }

    #post-navigator-prev {
      float: left;
    }

    #post-navigator-next {
      float: right;
    }

    .pages {
      text-align: center;
      margin-right: -15px;
      margin-left: -15px;
    }

    .pages>ul {
      font-weight: lighter;
    }

    .pages>.pagination {
      display: inline-block;
      padding-left: 0;
      margin: 20px 0px;
      border-radius: 4px;
    }

    .pages .pagination>li {
      display: inline;
    }

    .pagination>.active>a,
    .pagination>.active>span,
    .pagination>.active>a:hover,
    .pagination>.active>span:hover,
    .pagination>.active>a:focus,
    .pagination>.active>span:focus {
      z-index: 2;
      color: #fff;
      cursor: default;
      background-color: #428bca;
      border-color: #428bca;
    }

    .pagination>li>a,
    .pagination>li>span {
      position: relative;
      float: left;
      padding: 6px 12px;
      margin-left: -1px;
      line-height: 1.428571429;
      text-decoration: none;
      background-color: #fff;
      border: 1px solid #ddd;
    }

    .pagination>li:first-child>a,
    .pagination>li:first-child>span {
      margin-left: 0;
      border-bottom-left-radius: 4px;
      border-top-left-radius: 4px;
    }

    .pagination>.disabled>span,
    .pagination>.disabled>span:hover,
    .pagination>.disabled>span:focus,
    .pagination>.disabled>a,
    .pagination>.disabled>a:hover,
    .pagination>.disabled>a:focus {
      color: #999;
      cursor: not-allowed;
      background-color: #fff;
      border-color: #ddd;
    }

    .pagination>li:last-child>a,
    .pagination>li:last-child>span {
      border-top-right-radius: 4px;
      border-bottom-right-radius: 4px;
    }

    *,
    *:before,
    *:after {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
  <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
        <i class="fa fa-bars btn-mobile-menu__icon"></i>
        <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
         panel-cover
        panel-cover--collapsed " 
        style="background-image: url(/images/cover.jpg)" >
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content">
                    <a href="https://alimy.github.io//"> <img src="https://alimy.github.io/images/logo.jpg"
                            width="256" alt="北野 logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="https://alimy.github.io//">北野</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  那年江湖，遇见你  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                                <li class="navigation__item"><a href="https://alimy.github.io/" title="博客首页"
                                        class="blog-button">首页</a> </li> </br></br>
                                <li class="navigation__item"><a href="https://alimy.github.io/post" title="文章列表"
                                        class="blog-button">文章列表</a> </li>
                                </br>  </br>
                                <li class="navigation__item"><a href="https://alimy.github.io/pages/cv" title="关于我 "
                                        class="blog-button">关于我</a> </li>
                                </br> 
                            </ul>
                            <nav class="cover-navigation navigation--social">
</br>
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="https://iibiubiu.com" title="@iiBiuBiu" target="_blank"> <i class='fa fa-anchor'></i> <span class="label">Twitter</span> </a>
        </li>
        <li class="navigation__item">
            <a href="https://www.paopao.info/#/u?s=alimy" title="@paopao" target="_blank"> <i class='fa fa-leaf'></i> <span class="label">Twitter</span> </a>
        </li><br>
        
        
        
          
        
        <li class="navigation__item">
            <a href="https://github.com/alimy" title="@GitHub" target="_blank"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>   </br>    </ul>
</nav>

                        </nav>
                    </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</div>
<noscript>
    <style>
        #scriptHeader {
            display: none;
        }

        .navigation-wrapper {
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/cover.jpg)">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="https://alimy.github.io//"> <img src="https://alimy.github.io/images/logo.jpg" width="80"
                            alt="北野 logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="https://alimy.github.io//">北野</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  那年江湖，遇见你  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                                <li class="navigation__item"><a href="https://alimy.github.io/" title="博客首页"
                                        class="blog-button">Blog</a> </li></br></br>
                                <li class="navigation__item"><a href="https://alimy.github.io//post/" title="文章列表"
                                        class="blog-button">Articles</a> </li>
                                </br>  </br>
                                <li class="navigation__item"><a href="https://alimy.github.io/pages/cv" title="关于我 "
                                        class="blog-button">About Me</a> </li>
                                </br> 
                            </ul>
                        </nav> <nav class="cover-navigation navigation--social">
</br>
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="https://iibiubiu.com" title="@iiBiuBiu" target="_blank"> <i class='fa fa-anchor'></i> <span class="label">Twitter</span> </a>
        </li>
        <li class="navigation__item">
            <a href="https://www.paopao.info/#/u?s=alimy" title="@paopao" target="_blank"> <i class='fa fa-leaf'></i> <span class="label">Twitter</span> </a>
        </li><br>
        
        
        
          
        
        <li class="navigation__item">
            <a href="https://github.com/alimy" title="@GitHub" target="_blank"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>   </br>    </ul>
</nav>

                    </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>
  <div class="content-wrapper">
    <div class="content-wrapper__inner">
      <div class="post panel-wrapper">
        <h2>Memcached - A Story of Caching</h2>
        
        <p><em>ed note: this is an overview of basic memcached use case, and how memcached clients work</em></p>
<p>Two plucky adventurers, Programmer and Sysadmin, set out on a journey. Together they make websites. Websites with webservers and databases. Users from all over the Internet talk to the webservers and ask them to make pages for them. The webservers ask the databases for junk they need to make the pages. Programmer codes, Sysadmin adds webservers and database servers.</p>
<p>One day the Sysadmin realizes that their database is sick! It’s spewing bile and red stuff all over! Sysadmin declares it has a fever, a load average of 20! Programmer asks Sysadmin, “well, what can we do?” Sysadmin says, “I heard about this great thing called memcached. It really helped livejournal!” “Okay, let’s try it!” says the Programmer.</p>
<p>Our plucky Sysadmin eyes his webservers, of which he has six. He decides to use three of them to run the ‘memcached’ server. Sysadmin adds a gigabyte of ram to each webserver, and starts up memcached with a limit of 1 gigabyte each. So he has three memcached instances, each can hold up to 1 gigabyte of data. So the Programmer and the Sysadmin step back and behold their glorious memcached!</p>
<p>“So now what?” they say, “it’s not DOING anything!” The memcacheds aren’t talking to anything and they certainly don’t have any data. And NOW their database has a load of 25!</p>
<p>Our adventurous Programmer grabs the pecl/memcache client library manual, which the plucky Sysadmin has helpfully installed on all SIX webservers. “Never fear!” he says. “I’ve got an idea!” He takes the IP addresses and port numbers of the THREE memcacheds and adds them to an array in php.</p>
<pre tabindex="0"><code>$MEMCACHE_SERVERS = array(
    &#34;10.1.1.1&#34;, //web1
    &#34;10.1.1.2&#34;, //web2
    &#34;10.1.1.3&#34;, //web3
);
</code></pre><p>Then he makes an object, which he cleverly calls ‘$memcache’.</p>
<pre tabindex="0"><code>$memcache = new Memcache();
foreach($MEMCACHE_SERVERS as $server){
    $memcache-&gt;addServer ( $server );
}
</code></pre><p>Now Programmer thinks. He thinks and thinks and thinks. “I know!” he says. “There’s this thing on the front page that runs <code>SELECT * FROM hugetable WHERE timestamp &gt; lastweek ORDER BY timestamp ASC LIMIT 50000;</code> and it takes five seconds!” “Let’s put it in memcached,” he says. So he wraps his code for the SELECT and uses his $memcache object. His code asks:</p>
<p>Are the results of this select in memcache? If not, run the query, take the results, and PUT it in memcache! Like so:</p>
<pre tabindex="0"><code>$huge_data_for_front_page = $memcache-&gt;get(&#34;huge_data_for_front_page&#34;);
if($huge_data_for_front_page === false){
    $huge_data_for_front_page = array();
    $sql = &#34;SELECT * FROM hugetable WHERE timestamp &gt; lastweek ORDER BY timestamp ASC LIMIT 50000&#34;;
    $res = mysql_query($sql, $mysql_connection);
    while($rec = mysql_fetch_assoc($res)){
        $huge_data_for_front_page[] = $rec;
    }
    // cache for 10 minutes
    $memcache-&gt;set(&#34;huge_data_for_front_page&#34;, $huge_data_for_front_page, 0, 600);
}

// use $huge_data_for_front_page how you please
</code></pre><p>Programmer pushes code. Sysadmin sweats. BAM! DB load is down to 10! The website is pretty fast now. So now, the Sysadmin puzzles, “What the HELL just happened!?” “I put graphs on my memcacheds! I used cacti, and this is what I see! I see traffic to one memcached, but I made three :(.” So, the Sysadmin quickly learns the ascii protocol and telnets to port 11211 on each memcached and asks it:</p>
<p>Hey, ‘get huge_data_for_front_page’ are you there?</p>
<p>The first memcached does not answer…</p>
<p>The second memcached does not answer…</p>
<p>The third memcached, however, spits back a huge glob of crap into his telnet session! There’s the data! Only once memcached has the key that the Programmer cached!</p>
<p>Puzzled, he asks on the mailing list. They all respond in unison, “It’s a distributed cache! That’s what it does!” But what does that mean? Still confused, and a little scared for his life, the Sysadmin asks the Programmer to cache a few more things. “Let’s see what happens. We’re curious folk. We can figure this one out,” says the Sysadmin.</p>
<p>“Well, there is another query that is not slow, but is run 100 times per second. Maybe that would help,” says the Programmer. So he wraps that up like he did before. Sure enough, the server loads drops to 8!</p>
<p>So the Programmer codes more and more things get cached. He uses new techniques. “I found them on the list and the faq! What nice blokes,” he says. The DB load drops; 7, 5, 3, 2, 1!</p>
<p>“Okay,” says the Sysadmin, “let’s try again.” Now he looks at the graphs. ALL of the memcacheds are running! All of them are getting requests! This is great! They’re all used!</p>
<p>So again, he takes keys that the Programmer uses and looks for them on his memcached servers. ‘get this_key’ ‘get that_key’ But each time he does this, he only finds each key on one memcached! Now WHY would you do this, he thinks? And he puzzles all night. That’s silly! Don’t you want the keys to be on all memcacheds?</p>
<p>“But wait”, he thinks “I gave each memcached 1 gigabyte of memory, and that means, in total, I can cache three gigabytes of my database, instead of just ONE! Oh man, this is great,” he thinks. “This’ll save me a ton of cash. Brad Fitzpatrick, I love your ass!”</p>
<p>“But hmm, the next problem, and this one’s a puzzler, this webserver right here, this one running memcached it’s old, it’s sick and needs to be upgraded. But in order to do that I have to take it offline! What will happen to my poor memcache cluster? Eh, let’s find out,” he says, and he shuts down the box. Now he looks at his graphs. “Oh noes, the DB load, it’s gone up in stride! The load isn’t one, it’s now two. Hmm, but still tolerable. All of the other memcacheds are still getting traffic. This ain’t so bad. Just a few cache misses, and I’m almost done with my work. So he turns the machine back on, and puts memcached back to work. After a few minutes, the DB load drops again back down to 1, where it should always be.</p>
<p>“The cache restored itself! I get it now. If it’s not available it just means a few of my requests get missed. But it’s not enough to kill me. That’s pretty sweet.”</p>
<p>So, the Programmer and Sysadmin continue to build websites. They continue to cache. When they have questions, they ask the mailing list or read the faq again. They watch their graphs. And all live happily ever after.</p>
<p>Author: Dormando via IRC. Edited by Brian Moon for fun. Further fun editing by Emufarmers.</p>
<hr>
<p>本文转载自<a href="https://docs.memcached.org/tutorialcachingstory/" title="A Story of Caching">网络</a>.</p>
<p><em>本站为个人网站，集网络美文、技术文章与原创生活记录等，系孤芳自赏、个人用途，内容如有侵权请联系站长删除。</em></p>
        <div id="post-tags">
          
          
          <a href="https://alimy.github.io/tags/development/" class="post-tags-item"><i class="fa fa-tag" aria-hidden="true"></i>&nbsp;Development</a>
          
          <a href="https://alimy.github.io/tags/cache/" class="post-tags-item"><i class="fa fa-tag" aria-hidden="true"></i>&nbsp;Cache</a>
          
          <a href="https://alimy.github.io/tags/memcached/" class="post-tags-item"><i class="fa fa-tag" aria-hidden="true"></i>&nbsp;Memcached</a>
          
          
        </div>
      </div>
      <div id="post-navigator">
        <a id="post-navigator-prev" href="https://alimy.github.io/post/dev_202602191110/" title="上一篇"><i class="fa fa-chevron-left"
            aria-hidden="true"></i>&nbsp;Memcached - Meta Text Protocol</a>
        
      </div>
      
      <footer id="copyright">
  <p>&copy;2015-至今 <a href="mailto:alimy@niubiu.com" title="Email:alimy@niubiu.com">北野 - Michael Li</a> All rights
    reserved.&nbsp;&nbsp;<a href="https://riiffy.com/alimy.github.io" title="访问统计" target="_blank">Riiffy</p>
</footer>
    </div>
    <script>(function(){var WebP=new Image();WebP.onload=WebP.onerror=function(){
if(WebP.height!=2){var sc=document.createElement('script');sc.type='text/javascript';sc.async=true;
var s=document.getElementsByTagName('script')[0];sc.src='https://alimy.github.io/js/webpjs-0.0.2.min.js';s.parentNode.insertBefore(sc,s);}};
WebP.src='data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA';})();</script>

</body>

</html>