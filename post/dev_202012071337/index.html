  <!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <title> Tg: Service Messages &middot; 糊涂小栈 </title>
  
  <link rel="stylesheet" type="text/css" href="https://alimy.me/css/uno.css" />
  <link rel="stylesheet" type="text/css" href="https://alimy.me/css/lightGallery.css" />
  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://alimy.me/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://alimy.me/favicon.png">
  
  <script src="https://alimy.me/js/jquery.min.js"></script>
  <script src="https://alimy.me/js/main.min.js"></script>
  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-75081327-1', 'auto');
    ga('send', 'pageview');
  </script>

  
  <script>
    "use strict";

    !function () {
      var t = window.driftt = window.drift = window.driftt || [];
      if (!t.init) {
        if (t.invoked) return void (window.console && console.error && console.error("Drift snippet included twice."));
        t.invoked = !0, t.methods = ["identify", "config", "track", "reset", "debug", "show", "ping", "page", "hide", "off", "on"],
          t.factory = function (e) {
            return function () {
              var n = Array.prototype.slice.call(arguments);
              return n.unshift(e), t.push(n), t;
            };
          }, t.methods.forEach(function (e) {
            t[e] = t.factory(e);
          }), t.load = function (t) {
            var e = 3e5, n = Math.ceil(new Date() / e) * e, o = document.createElement("script");
            o.type = "text/javascript", o.async = !0, o.crossorigin = "anonymous", o.src = "https://js.driftt.com/include/" + n + "/" + t + ".js";
            var i = document.getElementsByTagName("script")[0];
            i.parentNode.insertBefore(o, i);
          };
      }
    }();
    drift.SNIPPET_VERSION = '0.3.1';
    drift.load('b8zniyzvbfap');
  </script>
  


  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3a6d014ea0071483644f909a8928f5f1";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  <style type="text/css">
    body {
      background-color: #f9f9f9;
    }

    .panel-wrapper {
      box-shadow: 0px 0px 8px rgba(68, 68, 68, .6);
      -moz-box-shadow: 0px 0px 8px rgba(68, 68, 68, .6);
      border-radius: 4px;
      -moz-border-radius: 4px;
      padding: 16px 24px;
      margin-top: 32px;
      background-color: #fff
    }

    .panel-wrapper:hover {
      box-shadow: 0px 0px 12px rgba(68, 68, 68, .6);
      -moz-box-shadow: 0px 0px 12px rgba(68, 68, 68, .6);
    }

    #more {
      margin-top: 16px;
    }

    #copyright {
      padding: 2em 0 0;
      display: block;
      font-size: .9em;
      color: #b3b3b3;
      width: 100%;
      text-align: center
    }

    #list-indicator {
      min-width: 48px;
      text-align: center;
      float: right;
      margin-right: 64px;
      background: rgba(68, 68, 68, .2);
      border-radius: 4px;
      -moz-border-radius: 4px;
      padding: 8px;
    }

    #list-date {
      color: #999;
      font-size: .9em;
      font-style: italic;
    }

    .post-tags-item {
      padding-left: .75rem !important;
      padding-right: .75rem !important;
      padding-top: .25rem !important;
      padding-bottom: .25rem !important;
      margin-right: .5rem !important;
      margin-top: .25rem !important;
      margin-bottom: .25rem !important;
      font-size: .875rem !important;
      color: #666666;
      display: inline-block !important;
      border-radius: .25rem !important;
      background-color: rgb(242 242 247) !important;
    }

    .post-tags-item:hover {
      color: #38b2ac;
    }

    #post-navigator {
      padding: 24px 0px 16px 0px;
      vertical-align: middle;
    }

    #post-navigator>a {
      display: block;
      color: #2479cc;
      text-decoration: none;
    }

    #post-navigator-prev {
      float: left;
    }

    #post-navigator-next {
      float: right;
    }

    .pages {
      text-align: center;
      margin-right: -15px;
      margin-left: -15px;
    }

    .pages>ul {
      font-weight: lighter;
    }

    .pages>.pagination {
      display: inline-block;
      padding-left: 0;
      margin: 20px 0px;
      border-radius: 4px;
    }

    .pages .pagination>li {
      display: inline;
    }

    .pagination>.active>a,
    .pagination>.active>span,
    .pagination>.active>a:hover,
    .pagination>.active>span:hover,
    .pagination>.active>a:focus,
    .pagination>.active>span:focus {
      z-index: 2;
      color: #fff;
      cursor: default;
      background-color: #428bca;
      border-color: #428bca;
    }

    .pagination>li>a,
    .pagination>li>span {
      position: relative;
      float: left;
      padding: 6px 12px;
      margin-left: -1px;
      line-height: 1.428571429;
      text-decoration: none;
      background-color: #fff;
      border: 1px solid #ddd;
    }

    .pagination>li:first-child>a,
    .pagination>li:first-child>span {
      margin-left: 0;
      border-bottom-left-radius: 4px;
      border-top-left-radius: 4px;
    }

    .pagination>.disabled>span,
    .pagination>.disabled>span:hover,
    .pagination>.disabled>span:focus,
    .pagination>.disabled>a,
    .pagination>.disabled>a:hover,
    .pagination>.disabled>a:focus {
      color: #999;
      cursor: not-allowed;
      background-color: #fff;
      border-color: #ddd;
    }

    .pagination>li:last-child>a,
    .pagination>li:last-child>span {
      border-top-right-radius: 4px;
      border-bottom-right-radius: 4px;
    }

    *,
    *:before,
    *:after {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }
  </style>
</head>

  <body>
    <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        " >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="https://alimy.me/"> <img src="https://alimy.me/images/logo.jpg" width="256" alt="北野 logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="https://alimy.me/">北野</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  糊涂小栈  </p>
                <hr class="panel-cover__divider panel-cover__divider--secondary" />
                <div class="navigation-wrapper">
                    <nav class="cover-navigation cover-navigation--primary">
                        <ul class="navigation">
                            <li class="navigation__item"><a href="https://alimy.me" title="博客首页" class="blog-button">Blog</a> </li> </br></br>
                            <li class="navigation__item"><a href="https://alimy.me/post/" title="文章列表" class="blog-button">Archive</a> </li>
                            </br>  </ul>
                            <nav class="cover-navigation navigation--social">
</br>
    <ul class="navigation"> 
        <li class="navigation__item">
            <a href="https://my.alimy.me/" title="@Memos" target="_blank"> <i class='fa fa-user-secret'></i> <span class="label">Twitter</span> </a>
        </li>
        <li class="navigation__item">
            <a href="https://www.paopao.info/#/user?username=alimy" title="@Paopao" target="_blank"> <i class='fa fa-anchor'></i> <span class="label">Twitter</span> </a>
        </li>
        <li class="navigation__item">
            <a href="https://iibiubiu.com" title="@iiBiuBiu" target="_blank"> <i class='fa fa-leaf'></i> <span class="label">Twitter</span> </a>
        </li>
          
        
        <li class="navigation__item">
            <a href="https://github.com/alimy" title="@GitHub" target="_blank"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>   </br>    </ul>
</nav>

                    </nav>  </div>
            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url()">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="https://alimy.me/"> <img src="https://alimy.me/images/logo.jpg" width="80" alt="北野 logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="https://alimy.me/">北野</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  糊涂小栈  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                                <li class="navigation__item"><a href="https://alimy.me/" title="博客首页" class="blog-button">Blog</a> </li>
                                </br>  </ul>
                        </nav> <nav class="cover-navigation navigation--social">
</br>
    <ul class="navigation"> 
        <li class="navigation__item">
            <a href="https://my.alimy.me/" title="@Memos" target="_blank"> <i class='fa fa-user-secret'></i> <span class="label">Twitter</span> </a>
        </li>
        <li class="navigation__item">
            <a href="https://www.paopao.info/#/user?username=alimy" title="@Paopao" target="_blank"> <i class='fa fa-anchor'></i> <span class="label">Twitter</span> </a>
        </li>
        <li class="navigation__item">
            <a href="https://iibiubiu.com" title="@iiBiuBiu" target="_blank"> <i class='fa fa-leaf'></i> <span class="label">Twitter</span> </a>
        </li>
          
        
        <li class="navigation__item">
            <a href="https://github.com/alimy" title="@GitHub" target="_blank"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>   </br>    </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <div class="post panel-wrapper">
            <h2>Tg: Service Messages</h2>
          
          <h4 id="response-to-an-rpc-query">Response to an RPC query</h4>
<p>A response to an RPC query is normally wrapped as follows:</p>
<pre><code>rpc_result#f35c6d01 req_msg_id:long result:Object = RpcResult;
</code></pre><p>Here req_msg_id is the identifier of the message sent by the other party and containing an RPC query. This way, the recipient knows that the result is a response to the specific RPC query in question. At the same time, this response serves as acknowledgment of the other party’s receipt of the req_msg_id message.</p>
<p>Note that the response to an RPC query must also be acknowledged. Most frequently, this coincides with the transmission of the next message (which may have a container attached to it carrying a service message with the acknowledgment).</p>
<h4 id="rpc-error">RPC Error</h4>
<p>The result field returned in response to any RPC query may also contain an error message in the following format:</p>
<pre><code>rpc_error#2144ca19 error_code:int error_message:string = RpcError;
</code></pre><h4 id="cancellation-of-an-rpc-query">Cancellation of an RPC Query</h4>
<p>In certain situations, the client does not want to receive a response to an already transmitted RPC query, for example because the response turns out to be long and the client has decided to do without it because of insufficient link capacity. Simply interrupting the TCP connection will not have any effect because the server would re-send the missing response at the first opportunity. Therefore, the client needs a way to cancel receipt of the RPC response message, actually acknowledging its receipt prior to it being in fact received, which will settle the server down and prevent it from re-sending the response. However, the client does not know the RPC response’s msg_id prior to receiving the response; the only thing it knows is the req_msg_id. i. e. the msg_id of the relevant RPC query. Therefore, a special query is used:</p>
<pre><code>rpc_drop_answer#58e4a740 req_msg_id:long = RpcDropAnswer;
</code></pre><p>The response to this query returns as one of the following messages wrapped in rpc_result and requiring an acknowledgment:</p>
<pre><code>rpc_answer_unknown#5e2ad36e = RpcDropAnswer;
rpc_answer_dropped_running#cd78e586 = RpcDropAnswer;
rpc_answer_dropped#a43ad8b7 msg_id:long seq_no:int bytes:int = RpcDropAnswer;
</code></pre><p>The first version of the response is used if the server remembers nothing of the incoming req_msg_id (if it has already been responded to, for example). The second version is used if the response was canceled while the RPC query was being processed (where the RPC query itself was still fully processed); in this case, the same rpc_answer_dropped_running is also returned in response to the original query, and both of these responses require an acknowledgment from the client. The final version means that the RPC response was removed from the server’s outgoing queue, and its msg_id, seq_no, and length in bytes are transmitted to the client.</p>
<p>Note that rpc_answer_dropped_running and rpc_answer_dropped serve as acknowledgments of the server’s receipt of the original query (the same one, the response to which we wish to forget). In addition, same as for any RPC queries, any response to rpc_drop_answer is an acknowledgment for rpc_drop_answer itself.</p>
<p>As an alternative to using rpc_drop_answer, a new session may be created after the connection is reset and the old session is removed through destroy_session.</p>
<p><strong>Messages associated with querying, changing, and receiving the status of other messages
See <a href="service_messages_about_messages.md">Mobile Protocol: Service Messages about Messages</a></strong>.</p>
<h4 id="request-for-several-future-salts">Request for several future salts</h4>
<p>The client may at any time request from the server several (between 1 and 64) future server salts together with their validity periods. Having stored them in persistent memory, the client may use them to send messages in the future even if he changes sessions (a server salt is attached to the authorization key rather than being session-specific).</p>
<pre><code>get_future_salts#b921bd04 num:int = FutureSalts;
future_salt#0949d9dc valid_since:int valid_until:int salt:long = FutureSalt;
future_salts#ae500895 req_msg_id:long now:int salts:vector&lt;future_salt&gt; = FutureSalts;
</code></pre><p>The client must check to see that the response’s req_msg_id in fact coincides with msg_id of the query for get_future_salts. The server returns a maximum of num future server salts (may return fewer). The response serves as the acknowledgment of the query and does not require an acknowledgment itself.</p>
<h4 id="ping-messages-pingpong">Ping Messages (PING/PONG)</h4>
<pre><code>ping#7abe77ec ping_id:long = Pong;
</code></pre><p>A response is usually returned to the same connection:</p>
<pre><code>pong#347773c5 msg_id:long ping_id:long = Pong;
</code></pre><p>These messages do not require acknowledgments. A pong is transmitted only in response to a ping while a ping can be initiated by either side.</p>
<h4 id="deferred-connection-closure--ping">Deferred Connection Closure + PING</h4>
<pre><code>ping_delay_disconnect#f3427b8c ping_id:long disconnect_delay:int = Pong;
</code></pre><p>Works like ping. In addition, after this is received, the server starts a timer which will close the current connection disconnect_delay seconds later unless it receives a new message of the same type which automatically resets all previous timers. If the client sends these pings once every 60 seconds, for example, it may set disconnect_delay equal to 75 seconds.</p>
<h4 id="request-to-destroy-session">Request to Destroy Session</h4>
<p>Used by the client to notify the server that it may forget the data from a different session belonging to the same user (i. e. with the same auth_key_id). The result of this being applied to the current session is undefined.</p>
<pre><code>destroy_session#e7512126 session_id:long = DestroySessionRes;
destroy_session_ok#e22045fc session_id:long = DestroySessionRes;
destroy_session_none#62d350c9 session_id:long = DestroySessionRes;
</code></pre><h4 id="new-session-creation-notification">New Session Creation Notification</h4>
<p>The server notifies the client that a new session (from the server’s standpoint) had to be created to handle a client message. If, after this, the server receives a message with an even smaller msg_id within the same session, a similar notification will be generated for this msg_id as well. No such notifications are generated for high msg_id values.</p>
<pre><code>new_session_created#9ec20908 first_msg_id:long unique_id:long server_salt:long = NewSession
</code></pre><p>The unique_id parameter is generated by the server every time a session is (re-)created.</p>
<p>This notification must be acknowledged by the client. It is necessary, for instance, for the client to understand that there is, in fact, a “gap” in the stream of long poll notifications received from the server (the user may have failed to receive notifications during some period of time).</p>
<p>Notice that the server may unilaterally destroy (close) any existing client sessions with all pending messages and notifications, without sending any notifications. This happens, for example, if the session is inactive for a long time, and the server runs out of memory. If the client at some point decides to send new messages to the server using the old session, already forgotten by the server, such a &ldquo;new session created&rdquo; notification will be generated. The client is expected to handle such situations gracefully.</p>
<h4 id="containers">Containers</h4>
<p><em>Containers</em> are messages containing several other messages. Used for the ability to transmit several RPC queries and/or service messages at the same time, using HTTP or even TCP or UDP protocol. A container may only be accepted or rejected by the other party as a whole.</p>
<p>Simple Container
A simple container carries several messages as follows:</p>
<pre><code>msg_container#73f1f8dc messages:vector message = MessageContainer;
</code></pre><p>Here message refers to any message together with its length and msg_id:</p>
<pre><code>message msg_id:long seqno:int bytes:int body:Object = Message;
</code></pre><p><strong>bytes</strong> is the number of bytes in the body serialization. All messages in a container must have msg_id lower than that of the container itself. A container does not require an acknowledgment and may not carry other simple containers. When messages are re-sent, they may be combined into a container in a different manner or sent individually.</p>
<p>MTProto container payloads have a limit of <code>2^15</code> bytes or <code>1020</code> messages, whichever limit is reached first.
Clients should group acknowledgments, state requests and message resend requests into three separate <code>msgs_ack</code>, <code>msgs_state_req</code>, <code>msg_resend_req</code> service messages with at most 8192 IDs each; these three messages will not be included in the <code>1020</code> message limit.</p>
<p>Empty containers are also allowed. They are used by the server, for example, to respond to an HTTP request when the timeout specified in http_wait expires, and there are no messages to transmit.</p>
<p><a href="https://github.com/tdlib/td/blob/master/td/mtproto/SessionConnection.cpp">Example implementation</a>.</p>
<h4 id="message-copies">Message Copies</h4>
<p>In some situations, an old message with a msg_id that is no longer valid needs to be re-sent. Then, it is wrapped in a copy container:</p>
<pre><code>msg_copy#e06046b2 orig_message:Message = MessageCopy;
</code></pre><p>Once received, the message is processed as if the wrapper were not there. However, if it is known for certain that the message orig_message.msg_id was received, then the new message is not processed (while at the same time, it and orig_message.msg_id are acknowledged). The value of orig_message.msg_id must be lower than the container’s msg_id.</p>
<p>This is not used at this time, because an old message can be wrapped in a simple container with the same result.</p>
<h4 id="packed-object">Packed Object</h4>
<p>Used to replace any other object (or rather, a serialization thereof) with its archived (gzipped) representation:</p>
<pre><code>gzip_packed#3072cfa1 packed_data:string = Object;
</code></pre><p>At the present time, it is supported in the body of an RPC response (i.e., as result in rpc_result) and generated by the server for a limited number of high-level queries. In addition, in the future it may be used to transmit non-service messages (i. e. RPC queries) from client to server.</p>
<h4 id="http-waitlong-poll">HTTP Wait/Long Poll</h4>
<p>The following special service query not requiring an acknowledgement (which must be transmitted only through an HTTP connection) is used to enable the server to send messages in the future to the client using HTTP protocol:</p>
<pre><code>http_wait#9299359f max_delay:int wait_after:int max_wait:int = HttpWait;
</code></pre><p>When such a message (or a container carrying such a message) is received, the server either waits <code>max_delay</code> milliseconds, whereupon it forwards all the messages that it is holding on to the client if there is at least one message queued in session (if needed, by placing them into a container to which acknowledgments may also be added); or else waits no more than <code>max_wait</code> milliseconds until such a message is available. If a message never appears, an empty container is transmitted.</p>
<p>The <code>max_delay</code> parameter denotes the maximum number of milliseconds that has elapsed between the first message for this session and the transmission of an HTTP response. The <code>wait_after</code> parameter works as follows: after the receipt of the latest message for a particular session, the server waits another wait_after milliseconds in case there are more messages. If there are no additional messages, the result is transmitted (a container with all the messages). If more messages appear, the wait_after timer is reset.</p>
<p>At the same time, the <code>max_delay</code> parameter has higher priority than <code>wait_after</code>, and <code>max_wait</code> has higher priority than <code>max_delay</code>.</p>
<p>This message does not require a response or an acknowledgement. If the container transmitted over HTTP carries several such messages, the behavior is undefined (in fact, the latest parameter will be used).</p>
<p>If no <code>http_wait</code> is present in container, default values <code>max_delay=0</code> (milliseconds), <code>wait_after=0</code> (milliseconds), and <code>max_wait=25000</code> (milliseconds) are used.</p>
<p>If the client’s ping of the server takes a long time, it may make sense to set max_delay to a value that is comparable in magnitude to ping time.</p>
<hr>
<p>(Notice: Origin official document is <a href="https://core.telegram.org/mtproto/description" title=" Service Messages"><em>Here</em></a>)</p>
				<div id="post-tags">
				  
				  	
						  <a href="https://alimy.me/tags/development/" class="post-tags-item"><i class="fa fa-tag" aria-hidden="true"></i>&nbsp;development</a>
						
						  <a href="https://alimy.me/tags/tg/" class="post-tags-item"><i class="fa fa-tag" aria-hidden="true"></i>&nbsp;tg</a>
						
					
				</div>
        </div>
        <div id="post-navigator">
          <a id="post-navigator-prev" href="https://alimy.me/post/dev_202012071333/" title="上一篇"><i class="fa fa-chevron-left" aria-hidden="true"></i>&nbsp;Tg: Binary Data Serialization</a>
          <a id="post-navigator-next" href="https://alimy.me/post/dev_202012081630/" title="下一篇">Tg: Current MTProto TL-schema&nbsp;<i class="fa fa-chevron-right" aria-hidden="true"></i></a>
        </div>
        <div id="post-comments">
          <h3>Comments</h3>
          


<div id="disqus_thread"></div>

<script type="text/javascript">
  var disqusUsername = "alimy";

  (function() { 
  var d = document, s = d.createElement('script');

  s.src = '//' + disqusUsername + '.disqus.com/embed.js';

  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


        </div>
        <footer id="copyright">
  <p>&copy;2015-2023 <a href="mailto:alimy@gility.net" title="Email:alimy@gility.net">北野 -  Michael Li</a> All rights reserved.</p>
</footer>

    </div>
    <script>(function(){var WebP=new Image();WebP.onload=WebP.onerror=function(){
if(WebP.height!=2){var sc=document.createElement('script');sc.type='text/javascript';sc.async=true;
var s=document.getElementsByTagName('script')[0];sc.src='https://alimy.me/js/webpjs-0.0.2.min.js';s.parentNode.insertBefore(sc,s);}};
WebP.src='data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA';})();</script>

  </body>
</html>
